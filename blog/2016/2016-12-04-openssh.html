---
layout: post
title: 'openssh: доступ до віддаленого комп''ютера'
date: '2016-12-04T19:31:00.000+02:00'
author: tivasyk
tags:
- ssh
- комп'ютери
- linux
- підказки
modified_time: '2019-06-12T19:06:14.462+03:00'
thumbnail: https://1.bp.blogspot.com/-UEOGJ26GtY4/WEI9qplEyKI/AAAAAAAA79k/K1TDPAxU22E66nAKWOg4T1DVOblwTKDJACLcB/s72-c/2016-12-02_duckdns.jpg
blogger_id: tag:blogger.com,1999:blog-1498862426470895405.post-7195175359387817870
blogger_orig_url: http://www.tivasyk.info/2016/12/openssh.html
---

<a href="https://1.bp.blogspot.com/-UEOGJ26GtY4/WEI9qplEyKI/AAAAAAAA79k/K1TDPAxU22E66nAKWOg4T1DVOblwTKDJACLcB/s1600/2016-12-02_duckdns.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="133" src="https://1.bp.blogspot.com/-UEOGJ26GtY4/WEI9qplEyKI/AAAAAAAA79k/K1TDPAxU22E66nAKWOg4T1DVOblwTKDJACLcB/s200/2016-12-02_duckdns.jpg" width="200" /></a>продовжую ексеприментувати з різними інструментами для віддаленої роботи з комп'ютером. мета — отримати зручний і прозорий доступ до інтернету з українського ip через vpn з канади.<br /><br />першу задачу — адресацію комп'ютера в україні незалежно від динамічно виданого ip, — майже вирішено тут:<br /><ul><li><a href="http://www.tivasyk.info/2016/12/duckdns-ip.html" target="_blank">duckdns: адресація віддаленої машини з динамічним ip</a> </li></ul>майже, бо поки що я адресую рутер, за якою ця машина ховається. наступна задача — отримати доступ до комп'ютера в україні по ssh.<br /><br /><h3>openssh: командний рядок на віддаленому комп'ютері</h3>підключаюсь до комп'ютера в україні за допомогою того ж таки teamviewer'а — і вкотре радію, що перед від'їздом налаштував цей спосіб доступу: не елегантно, але працює. створюю собі там новий користувацький профіль (нехай <i>test_ssh</i>), щоби не логінитися через ssh в той, під яким там працюють люди. <br /><br /><a name='more'></a>далі відкриваю там термінал, встановлюю openssh:<br /><br /><pre><code>sudo apt-get install openssh-server</code></pre><br />для manjaro та інших похідних від arch інакше:<br /><br /><pre><code>sudo pacman -S openssh</code></pre><br />роблю резервну копію загальносистемного файлу налаштувань openssh:<br /><br /><pre>sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup<br /><span class="anchor" id="line-2"></span>sudo chmod a-w /etc/ssh/sshd_config.backup</pre><br />редагую налаштування:<br /><br /><pre><code>sudo nano /etc/ssh/sshd_config</code></pre><br />…і бемц — перечіпляюся через один з глюків teamviewer'а: незалежно від налаштування «send key combinations», nano на тій стороні не отримує ctrl+o чи ctrl+x, тож неможливо ані зберегти файл, ані коректно закрити редактор. на щастя, маю там midnight commander, і mcedit нормально отримує комбінації ctrl+fx, тож:<br /><br /><pre><code>sudo mcedit /etc/ssh/sshd_config</code></pre><br />роблю деякі невеликі зміни в шаблонному файлі конфігурації openssh <a href="https://help.ubuntu.com/community/SSH/OpenSSH/Configuring" target="_blank">за хорошою онлайновою підказкою</a>. по-перше, залишаю поки що стандартний порт ssh (22) та автентифікацію паролем — спершу треба переконатися, що ланцюжок плацює, а тоді вже експериментувати з портами і ключами безпеки:<br /><br /><pre><code>Port 22<br />PasswordAuthentication yes</code></pre><br />логін рутом? дивно, що таке дозволено в шаблоні! виправляю:<br /><br /><pre><code>PermitRootlogin no</code></pre><br />а щоби лише моєму користувачеві дозволено було підключатися по ssh, обмежую список користувачів:<br /><br /><pre><code>AllowUsers test_ssh</code></pre><br />(насправді мій профіль називається інакше — хто ж публікує таке в щоденнику?) щоби випробувати <b>тунелювання X11</b> (програми з інтерфейсом XWindows можуть виконуватися на віддаленій машині, але інтерфейс показувати на моїй — це ж круто, ні?), залишаю/додаю таке:<br /><br /><pre><code>X11Forwarding yes<br />X11DisplayOffset 10<br />X11UseLocalhost yes</code></pre><br />для початку досить. запускаю сервіс ssh на віддаленій машині:<br /><br /><pre><code>sudo restart ssh</code></pre><br />(так це працює на debian та похідних; на arch'і треба скористатися systemctl). після цього в теорії сервіс ssh має працювати на віддаленій машині й слухати порт 22, а коли приходить запит від користувача <i>test_ssh</i> — запитати пароль і дати доступ до командного рядка:<br /><br /><pre><code>ssh test_ssh@tivasyk_ukraine.duckdns.org</code></pre><br />на ділі ж нічого не вийде, тому що…<br /><br /><h3>рутер і файрволи</h3>…між двома комп'ютерами є рутер (і це саме рутер, а не машина в його локальній мережі має отой динамічний ip, що на нього посилається tivasyk_ukraine.duckdns.org), а на самих комп'ютерах є файрволи. і це ще якщо власне канал в інтернеті «прозорий» і жоден з провайдерів між двома комп'ютерами не блокує ssh.<br /><br />почав з файрволів. тут є два варіанти: поганий — вимкнути (хоча для тестування годиться), і правильний — налаштувати «вікно» у файрволі для ssh (порт 22, вхід/вихід, <a href="https://superuser.com/questions/742331/what-does-ssh-use-udp-for" target="_blank">tcp</a>); робиться елементарно за допомогою того чи іншого графічного інтерфейсу до iptables.<br /><br />на рутері потрібно налаштувати <b>форвардинг (переадресацію) для порту 22</b>. коротко: рутер отримує запит на порт 22 і просто його ігнорує, тому що не підтримує ssh (звісно, якщо це не <a href="https://www.dd-wrt.com/wiki/index.php/SSH" target="_blank">рутер з прошивкою ddwrt і налаштованим ssh</a>!) — потрібно вказати йому переадресовувати всі запити на порт 22 до певної машини в локальній мережі.<br /><br />рутер в україні — недорогий tp-link, але з веб-інтерфейсом і досить непоганим набором можливостей. через той-таки teamviewer відкриваю той веб-інтерфейс у вогнелисі. по-перше, <a href="http://www.tp-link.com/us/faq-182.html" target="_blank">резервую ip</a> для моєї віддаленої машини в налаштуваннях dhcp рутера (в більшости випадків буде щось на кшалт 192.168.0.101 чи 192.168.1.101) — тепер комп'ютер матиме постійний ip без необхідності морочитися з налаштуванням статичного ip на обох пристроях. по-друге, налаштовую <a href="http://www.tp-link.com/en/faq-72.html" target="_blank">переадресацію порту</a> на цей комп'ютер.<br /><br />от тепер можна і спробувати (на локальній машині):<br /><br /><pre><code>ssh test_ssh@tivasyk_ukraine.duckdns.org</code></pre><br />настправді в мене це не одразу спрацювало, і я трохи «посмикав» файрволи на обох машинах та переадресацію порту на рутері… і хоч наче нічого не міняв, зненацька я отримав запрошення:<br /><br /><pre><code>tivasyk_ssh@notebook:~$</code></pre><br />зробив ls, щоби перевірити — таки працює!<br /><br /><h3>результат: доступ до комп'ютера в україні по ssh</h3>отже, тепер я можу відкривати термінал з командним рядком на віддаленому комп'ютері в україні. що далі?<br /><ul><li>навчитися копіювати файли собі з віддаленого пк (<a href="https://support.suso.com/supki/SSH_Tutorial_for_Linux#Using_SCP" target="_blank">scp</a>);</li><li>підключити свою домашню теку віддаленої машини як теку на локальній (<a href="https://wiki.archlinux.org/index.php/SSHFS" target="_blank">sshfs</a>);</li><li>спробувати, як працює форвардинг X11 (і <a href="http://xmodulo.com/how-to-speed-up-x11-forwarding-in-ssh.html" target="_blank">оптимізувати швидкість</a>);</li><li>налаштувати <a href="http://docstore.mik.ua/orelly/networking_2ndEd/ssh/ch09_03.htm" target="_blank">vnc</a>, щоби позбутися teamviewer'а і відключити форвардинг X11;</li><li>розібратися з перевагами/недоліками <a href="https://support.suso.com/supki/SSH_Tutorial_for_Linux#TCP_Port_Forwarding" target="_blank">форвардінгу tcp</a>, <a href="https://wiki.archlinux.org/index.php/VPN_over_SSH" target="_blank">vpn через ssh</a> та <a href="https://wiki.archlinux.org/index.php/OpenVPN" target="_blank">openvpn</a>;</li><li>почитати, які ще «фокуси» можна робити через ssh; </li><li>і при тім усім — не завалити <a href="http://www.tivasyk.info/2016/11/blog-post_35.html" target="_blank">іспит на водійську посвідку</a>, він вже за три дні! </li></ul>далі буде. 