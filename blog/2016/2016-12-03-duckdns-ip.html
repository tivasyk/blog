---
layout: post
title: 'duckdns: адресація віддаленої машини з динамічним ip'
date: '2016-12-03T19:09:00.001+02:00'
author: tivasyk
tags:
- комп'ютери
- linux
- підказки
modified_time: '2016-12-04T19:34:28.001+02:00'
thumbnail: https://1.bp.blogspot.com/-UEOGJ26GtY4/WEI9qplEyKI/AAAAAAAA79k/K1TDPAxU22E66nAKWOg4T1DVOblwTKDJACLcB/s72-c/2016-12-02_duckdns.jpg
blogger_id: tag:blogger.com,1999:blog-1498862426470895405.post-7357602317760198257
blogger_orig_url: http://www.tivasyk.info/2016/12/duckdns-ip.html
---

<a href="https://1.bp.blogspot.com/-UEOGJ26GtY4/WEI9qplEyKI/AAAAAAAA79k/K1TDPAxU22E66nAKWOg4T1DVOblwTKDJACLcB/s1600/2016-12-02_duckdns.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="133" src="https://1.bp.blogspot.com/-UEOGJ26GtY4/WEI9qplEyKI/AAAAAAAA79k/K1TDPAxU22E66nAKWOg4T1DVOblwTKDJACLcB/s200/2016-12-02_duckdns.jpg" width="200" /></a>попри чималий вже досвід використання linux, я майже чайник у багатьох питаннях, що стосуються налаштування серверних функцій. аж ось виникло бажання навчитися деяких фокусів — приміром, підключатися по ssh до віддаленого комп'ютера (я в канаді, комп'ютер — в україні), дистанційно налаштувати там vpn і зробити собі зашифроване вікно у світ.<br /><br />після закриття fs.to і ex.ua задача трохи втратила свою актуальність, але не зовсім: лишаються торенти, за які тут можуть надавати по руцях. ну і взагалі — чи не сором цього не вміти, користуючись linux'ом? отож.<br /><br />наразі на віддаленій машині працює teamviewer — чудовий інструмент, але не&nbsp; «канонічний»: не вільний і працює над wine'ом, що прийнятно для запуску забавок, але не для більш чи менш серйозних задач.<br /><br /><h3><b>duckdns: як </b>«пробити» динамічний ip</h3>отже, задача — «пробити» динамічний ip (себто, задача не в самім ip, зрозуміло, а в тому, щоби <b>адресувати віддалену машинку, яка отримує динамічний ip від свого провайдера</b>). найвідоміший сервіс — <a href="http://dyndns.com/" target="_blank">dyndns</a>, але він віднедавна недоступний задурно. з чималої кількости альтернатив зупинився на <a href="http://duckdns.org/" target="_blank">duckdns</a>. сервіс прекрасний своїм мінімалізмом.<br /><br /><a name='more'></a>переглянув <a href="https://www.duckdns.org/install.jsp" target="_blank">інструкцію на duckdns.org</a> та ще одну <a href="https://forums.freenas.org/index.php?threads/how-to-install-duckdns-org-a-how-to-guide.24170/" target="_blank">покрокову підказку</a> в тенетах. зареєструвався через twitter (можна facebook чи google plus), отримав свій унікальний ідентифікатор (token в термінах duckdns); зареєстрував два домени — один для віддаленої машини (умовно tivasyk_ukraine), а другий — суто для тестування на локальному ноутбуці (tivasyk_test).<br /><br />простий варіант команди для поновлення запису ip на duckdns для певного домену:<br /><br /><pre><code>/usr/local/bin/curl "https://www.duckdns.org/update?domains=tivasyk_test&amp;token=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx&amp;ip="</code></pre><br />перевірив на локальній машині — ip на сайті поновився на мій поточний, і тепер машинка пінгується за доменним іменем:<br /><br /><code>ping tivasyk_test.duckdns.org</code><br /><br />пробую те саме на віддаленій машині, підключившись через teamviewer:<br /><br /><pre><code>/usr/local/bin/curl "https://www.duckdns.org/update?domains=tivasyk_ukraine&amp;token=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx&amp;ip="</code></pre><code>ping tivasyk_ukraine.duckdns.org </code><br /><br />працює! <b>&nbsp;</b><br /><br /><h3><b>cron: </b>періодичне виконання</h3>налаштувати періодичне виконання цієї команди, щоби віддалена машина самотужки звітувала про свій ip на duckdns.<br /><br />як я зрозумів, є принаймні два варінати рішень: <a href="https://wiki.archlinux.org/index.php/Dynamic_DNS#ddclient" target="_blank">ddclient</a> або cron. перший автоматизує процес за допомогою perl-скрипта, другий — змушує системний планувальник запускати періодично вказану вище команду.<br /><br />cron канонічніший. за підказкою duckdns треба за допомогою <i>crontab -e</i> додати рядок до списку задач cron у хитромудрому форматі: <br /><br /><pre><code>*/5 * * * * /usr/local/bin/curl <br />"https://www.duckdns.org/update?domains=tivasyk_ukraine&amp;token=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx&amp;ip="</code></pre><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-csB7YN2WGJY/WELRKJ3hjwI/AAAAAAAA790/n2yWbnV0eV005YHSwOD4Ceb5lz63FVeeQCLcB/s1600/2016-12-03_gnome_scheduler.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="133" src="https://3.bp.blogspot.com/-csB7YN2WGJY/WELRKJ3hjwI/AAAAAAAA790/n2yWbnV0eV005YHSwOD4Ceb5lz63FVeeQCLcB/s200/2016-12-03_gnome_scheduler.jpg" width="200" /></a></div>(насправді ducksdns радить трохи інакше, але щоби не морочитися з окремим файлом скрипта, можна й так). але я трохи чітер, тож встановив собі gnome scheduler і скористався графічним інтерфейсом для цього.<br /><br />на віддаленій машині (elementary os на базі ubuntu) сервіс cron, здається, працює «з коробки», принаймні пошук демона повертає номер відповідного процесу:<br /><br /><pre><code>pidof crond</code></pre><br />якщо не працює, то:<br /><br /><pre><code>sudo service cron start</code></pre><br />а от на моєму ноутбуці (manjaro на базі arch linux) довелося спершу <a href="https://stackoverflow.com/questions/23146514/crontab-not-working-under-arch-linux" target="_blank">запустити cronie</a>, і тоді перевірка статусу сервіса показує, що задача виконується:<br /><br /><code>systemctl enable cronie<br />systemctl start cronie<br />systemctl status cronie</code><br /><br />наче працює. але тут мені захтілося спробувати ще й ddclient. отже…<br /><br /><h3>ddclient: альтернативний спосіб</h3><a href="https://wiki.archlinux.org/index.php/Dynamic_DNS#ddclient" target="_blank">ddclient</a> — це perl-скрипт, що сам опікується поновленням інформації про поточний ip на онлайнових сервісах на кшалт dyndns, при цьому підтримує їх цілу купу включно з duckdns. встановлюється з репозиторіїв; для debian/ubuntu та похідних:<br /><br /><pre><code>sudo apt-get install ddclient</code></pre><br />для arch та похідних:<br /><br /><pre><code>sudo pacman -S ddclient</code></pre><br />перед першим запуском… стривайте, треба ж <b>прибрати задачу cron</b>, створену раніше. отже, перед запуском сервіса роблю бекап файлу конфігурації <i>/etc/ddclient/ddclient.conf</i> і редагую, як <a href="https://sourceforge.net/p/ddclient/code/HEAD/tree/trunk/sample-etc_ddclient.conf" target="_blank">пише книжка</a> — потрібно просто розкоментувати (або додати, якщо не було в шаблоні) розділ для duckdns:<br /><br /><pre>##<br />## Duckdns (http://www.duckdns.org/)<br />##<br />password=<code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx</code></pre><pre>protocol=duckdns tivasyk_test</pre><pre></pre><br />за пароль слугує ідентифікатор (token), призначений duckdns. далі вмикаю і запускаю сервіс:<br /><br /><pre><code>sudo systemctl enable ddclient.service<br />sudo systemctl start ddclient.service</code></pre><br />і можна перевірити, чи працює:<br /><br /><pre><code>sudo systemctl status ddclient.service</code></pre><br />здається, працює. складно сказати, бо рутер не відключався, нову адресу для нього провайдер не видавав, відповідно на сайті duckdns.org мій айпішник не мінявся.<br /><br /><h3>результат: адресація машини з динамічним ip</h3>ну і, власне, результат — заради чого все робилося. я не знаю ip віддаленої машини, але повинна працювати адресація за доменним іменем (пінгую обидва комп'ютери по черзі):<br /><br /><pre><code>ping tivasyk_ukraine.duckdns.org<br />ping tivasyk_test.duckdns.org</code></pre><br />звісно, поки що <b>пінгуються зовсім не комп'ютери, а рутери</b>. до речі, пінг на рутер в мережі freenet — близько 140-150 мс зараз.<br /><br />досвіченим користувача linux все це нецікаво, але я занотовую собі на згадку, і хто зна, може ще для когось це правитиме за підказку. наразі все, <a href="http://www.tivasyk.info/2016/12/openssh.html" target="_blank">далі буде</a>: встановлення openssh, налаштування (якщо знадобиться) форвардингу ssh на рутері, ну і далі дослідження на тему практичного використання ssh в побуті =)