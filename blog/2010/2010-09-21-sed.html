---
layout: post
title: sed — проста вулична текстова магія
date: '2010-09-21T19:01:00.007+03:00'
author: tivasyk
tags:
- комп'ютери
- linux
- підказки
modified_time: '2010-09-22T18:22:27.061+03:00'
thumbnail: http://1.bp.blogspot.com/_wFmUV6FUCKU/TJisR1FMGYI/AAAAAAAAJCM/LnN9BRs5JuQ/s72-c/terminal_icon.png
blogger_id: tag:blogger.com,1999:blog-1498862426470895405.post-7925825060196748166
blogger_orig_url: http://www.tivasyk.info/2010/09/sed.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/_wFmUV6FUCKU/TJisR1FMGYI/AAAAAAAAJCM/LnN9BRs5JuQ/s1600/terminal_icon.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="200" src="http://1.bp.blogspot.com/_wFmUV6FUCKU/TJisR1FMGYI/AAAAAAAAJCM/LnN9BRs5JuQ/s200/terminal_icon.png" width="200" /></a></div>вже давно я — затятий користувач мишок і графічних інтерфейсів! — <a href="http://www.tivasyk.info/2009/10/blog-post_27.html">зачудований прихованою магією командного рядка</a>. якось із часом так виходить, що все більше повсякденних задачок на нетбуці вирішую радше в терміналі, аніж мишкою по кнопочках. але разом з тим чимраз сильніше відчуваю, який же ж я профан в цім ділі.<br /><br />особливо дався взнаки брак знань, коли <a href="http://www.tivasyk.info/2009/09/conky_24.html">розбирався з реалізацією календаря</a> на стільниці через <i>conky</i> та <i>sed</i>. от саме <a href="http://uk.wikipedia.org/wiki/Sed">sed</a> вразив мене найбільше, — і я пообіцяв собі колись обов’язково навчитися ним користуватися. <br /><br />дещо пізніше я натрапив у тенетах на чудову статтю<a href="http://www.catonmat.net/blog/sed-one-liners-explained-part-one/"> «famous sed one-liners explained»</a> — але сама собою вона нікого нічого не навчить. потрібно все пропустити «через себе» і спробувати на практиці. а заразом — перекласти окремі фрагменти укранською: може, комусь ще стане в нагоді.<br /><br /><a name='more'></a>(<a href="#1_1">пропустити вступ і перейти одразу до посібника sed</a>) <br /><br /><a name="0_1"></a><br /><h2>дуже коротко про sed</h2>досить детально про <a href="http://uk.wikipedia.org/wiki/Sed">потоковий неінтерактивний текстовий редактор sed</a> розказано у вікіпедії.<br /><br />коротко: <i>sed</i> завантажує один рядок тексту з вхідного буфера (<i>input stream</i>) до сховища шаблону (<i>pattern space</i>), застосовує до нього набір команд, заданий параметрами у командному рядку, видає результат до вихідного потоку (<i>output stream</i>), — і повторює з наступним рядком тексту, аж доки не впорається з усім вмістом вхідного потоку. команди можуть бути різні, але найбільш типова — знайти певну послідовність символів згідно шаблону (<a href="http://uk.wikipedia.org/wiki/%D0%A0%D0%B5%D0%B3%D1%83%D0%BB%D1%8F%D1%80%D0%BD%D0%B8%D0%B9_%D0%B2%D0%B8%D1%80%D0%B0%D0%B7">регулярний вираз</a>) і замінити чимось іншим. так — рядок за рядком — <i>sed</i> здатен обробити величезні об’єми тексту.<br /><br />втім, досить важко зрозуміти, що воно таке і навіщо треба, доки не спробуєш на практиці.<br /><br /><a name="0_2"></a><br /><h2>застереження та підготовка</h2>досвічені користувачі *nix та консолі не читатимуть цей текст — бо вже, певно, вивчили <i>sed</i> one-liners напам’ять =) <b>початківців застережу</b>: найперше я пишу для себе, це просто «нотатки на полях», тож я й не збираюся перекладати дослівно <a href="http://www.catonmat.net/blog/sed-one-liners-explained-part-one/">«famous sed one-liners explained»</a>. зате на відміну від оригіналу будуть живі приклади.<br /><br />ще підказка для початківців: спробувати власноруч будь-який приклад з подальшого можна, просто набравши в терміналі щось таке:<br /><blockquote><code> echo "простий приклад" | sed &lt;команда&gt;</code></blockquote>або, якщо на вході потрібен текст з кількох рядків, таке:<br /><blockquote><code> echo -e "перший рядок\nдругий рядок" | sed &lt;команда&gt;</code></blockquote>проте набирати щоразу тексти з клавіатури набридає — тож я собі підготував простий тестовий файл з кількома рядками тексту, створивши файл <i>test.txt</i> у простому текстовому редакторі <i>nano</i>:<br /><blockquote><code> cd ~<br />nano test.txt</code></blockquote>…і надрукувавши <a href="http://uk.wikisource.org/wiki/%D0%A1%D1%82%D0%B0%D1%80%D0%B5%D1%86%D1%8C_%28%D0%B4%D1%83%D0%BC%D0%B0%29">дві перших строфи зі «старця»</a> пантелеймона куліша. не дивуйтеся, якщо ці рядки щоразу з’являтимуться тут в прикладах роботи <i>sed</i>. вихідний файл виглядає точнісінько ось так (табуляція на початку парних рядків кожної строфи, пустий рядок між строфами):<br /><blockquote><code>Бринь бандура, та й замовкне…<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Чом же не заграє?<br />Стоїть старець під віконцем, —<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Чом же не співає?<br /><br />Ой ходив би я по селах<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Од хати до хати,<br />Ой співав би на ввесь голос, —<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Нікому співати!</code></blockquote>тепер, щоби змусити <i>sed</i> обробити тексту файлі <i>test.txt</i>, достатньо буде скомандувать таке:<br /><blockquote><code>cat ~/test.txt | sed &lt;команда&gt;</code></blockquote>результат виконання такої команди буде виведено в термінал — але якщо потрібно зберегти його в файл, скажімо test2.txt, необхідно додати <i>&gt; test2.txt</i> на кінці:<br /><blockquote><code>cat ~/test.txt | sed &lt;команда&gt; &gt; test2.txt</code></blockquote>підказку (англійською) щодо використання <i>echo</i>, <i>cat</i>, <i>sed</i> чи <i>nano</i>, можна отримати, скориставшись командою <i>man</i>:<br /><blockquote><code> man echo</code></blockquote>ну, наразі досить підказок. до справи.<br /><br /><a name="1_1"></a><br /><h2>1. відступи та інтервали</h2><br /><h3>1.1. подвійний інтервал між рядками</h3>задача: додати пустий рядок після кожного текстового рядка у файлі для імітації подвійного інтерліньяжу.<br /><blockquote><code>sed G</code></blockquote>редактор завантажує кожен рядок запропонованого тексту, додає у хвіст символ нового рядка, видає результат у вихідний потік, — і повторює операцію з кожним наступним рядком.<br /><br />приклад:<br /><blockquote><code>cat test.txt | sed G</code></blockquote>результат — вивід на екрані з подвійним інтервалом між рядками<br /><br /><a name="1_2"></a><br /><h3>1.2. потрійний інтервал між рядками</h3>задача: додати два пустих рядки після кожного текстового.<br /><blockquote><code>sed 'G;G'</code></blockquote>редактор може застосовувати до тексту кілька команд послідовно, якщо команди розділено крапкою з комою. важливо! складні команди (більше одного символа) необхідно заключати в одинарні прямі лапки.<br /><br />приклад:<br /><blockquote><code>cat ~/test.txt | sed 'G;G'</code></blockquote>результат очевидний: вивід на екрані з подвійним інтервалом між рядками.<br /><br /><a name="1_3"></a><br /><h3>1.3. «розумне» додавання подвійного інтервалу між рядками</h3>задача: додати пусті рядки лише там, де їх ще немає, уникаючи подвоєння і прибравши зайві.<br /><blockquote><code>sed '/^$/d;G'</code></blockquote>редактор дозволяє застосовувати команди вибірково — лише до рядків, що відповідають шаблону. в даному випадку шаблон <i>/^$/</i> відбирає лише пусті рядки, що не містять тексту — а наступна команда <i>d</i> видаляє кожен такий рядок; непусті (текстові) рядки буде пропущено без змін. наступна команда <i>G</i> відділена крапкою з комою — і отже застосовується останньою, вже над результатом попередньої команди, тобто і над пустими (що не містять тепер навіть переносу рядка!), і над текстовими рядками.<br /><br />приклад:<br /><blockquote><code>cat test.txt | sed '/^$/d;G'</code></blockquote>результат: скільки б не було пустих рядків між текстовими початково, команда видалить їх усі — і додасть лише один розріджувальний.<br /><br />але стривайте, як перевірити? адже у підготовленому заздалегідь тексті не було пустих рядків? а приміром ось так — застосувавши до тексту спершу потроєння інтерліньяжа (п. 1.2), а тоді цю «розумну» команду:<br /><blockquote><code>cat ~/test.txt | sed 'G;G' | sed '/^$/d;G'</code></blockquote>результат: вивід на екрані лише з подвійним (!) інтервалом між рядками.<br /><br /><a name="1_4"></a><br /><h3>1.4. вилучити пусті рядки</h3>задача: маючи файл з подвійним чи потрійним інтервалом між рядками, або й з нерегулярним розподілом пустих рядків, привести його до «щільного» вигляду лише з текстовими рядками.<br /><blockquote><code>sed '/^$/d'</code></blockquote>оригінальний текст «famous sed one-liners» пропонує інший варіант команди: <i>sed 'n;d'</i>… але він покладається на те, що кожен непарний рядок у файлі — пустий… але якщо це раптом не так? насправді задача вирішується інакше — звикористанням фрагменту з попереднього прикладу: фільтр <i>/^$/</i> відбирає кожен пустий рядок на вході, команда d видаляє його (тобто очищує робочий буфер), і <i>sed </i>завантажує наступний рядок; якщо він текстовий — фільтр його пропускає на вихід без змін.<br /><br />щоб перевірити, як воно працює — спершу згенеруємо файл <i>test2.txt</i>, скажімо, з потрійним інтервалом (див. п. <a href="#1_2">1.2</a>):<br /><blockquote><code>cat test.txt | sed G</code></blockquote>і тепер спробуємо. приклад:<br /><blockquote><code>cat test.txt | sed '/^$/d'</code></blockquote>результат: вивід на екрані без пустих інтервалів між текстовими рядками.<br /><br /><a name="1_5"></a><br /><h3>1.5. вилучити парні рядки</h3>задача: вилучити усі парні (кожен другий, тобто другий, четвертий і т.д.) рядки в тексті.<br /><blockquote><code>sed 'n;d'</code></blockquote>тут починається цікаве, бо логіка роботи цієї команди не одразу зрозуміла. команда <i>n</i> просто видає у вихідний потік поточний вміст робочого буфера, і (одразу) завантажує наступний рядок (другий) зі вхідного потоку. наступна команда <i>d </i>очищує вміст робочого буфера (тобто видаляє парний рядок!), не видаючи нічого у вихід — і завантажує наступний (третій!) рядок. і так далі. цікаво, що схожана перший погляд задача — видалити лише непарні рядки — так просто не вирішується. до неї доведеться взятися пізніше.<br /><br />приклад:<br /><blockquote><code>cat test.txt | sed 'n;d'</code></blockquote>результат: у текстовому виводі залишаться лише непарні рядки файлу <i>test.txt</i>.<br /><br /><a name="1_6"></a><br /><h3>1.6.&nbsp;вставити пусті рядки над вибраним текстом</h3>задача: вставити пусті рядки вибірково, перед кожним рядком, що відповідає певному шаблону.<br /><blockquote><code>sed '/regex/{x;p;x;}'</code></blockquote>тут <i>regex</i> — шаблон, заданий регулярним виразом. приміром, вже відомий (<a href="#1_3">див. п. 1.3</a>) вираз&nbsp; <i>/^$/</i> дозволяє вибрати кожен пустий рядок і застосувати до нього наступні команди. але дублювати таким чином інтервали нецікаво, бо це можна зробити простіше:<br /><blockquote><code>sed '/^$/p'</code></blockquote>тут фільтр вибирає пусті рядки, а команда <i>p</i> просто дублює їх — текстові ж рядки пропускаються без змін. а команда <i>{x;p;x;}</i> значно цікавіша і корисніша, бо працює інакше.<br /><br />команда <i>x</i> обмінює вміст робочого буфера (<i>pattern space</i>) і буфера пам’яті (<i>hold buffer</i>); якщо до цього часу в буфер пам’яті ще нічого не зберігалося — він пустий; отже, перша <i>x</i> запам’ятовує поточний рядок в пам’яті, а пустий рядок поміщає в робочий буфер. далі <i>p</i> друкує поточний буфер (пустий рядок), а наступна <i>x</i> знову завантажує з буфера пам’яті збережений рядок, а туди повертає пустий рядок — і оскільки це остання команда, <i>sed</i> друкує поточний вміст робочого буфера.<br /><br /><b>важливо!</b> фігурні дужки групують команди, щоби вони виконувалися над рядком, що відповідає шаблону, всі разом — інакше, якщо їх опустити, до вибраного згідно шаблону рядка було б застосовано лише першу <i>x</i>, а наступні <i>p;x;</i> застосовувалися б до усіх без винятку рядків.<br /><br />для прикладу якогось корисного шаблону можна взяти такий: <i>/^[^\t]/</i> — він відбиратиме рядки, що <b>не починаються</b> з символа табуляції (див. <a href="#0_2">тестовий текст у файлі <i>test.txt</i></a>). <br /><br />приклад:<br /><blockquote><code>cat test.txt | sed '/^[^\t]/ {x;p;x;}'</code></blockquote>результат: вивід в терміналі, в якому перед кожним текстовим рядком, що не починається табуляцією, буде додано пустий рядок.<br /><br />це перший справді корисний на практиці приклад, бо вибираючи шаблони відповідно до потенційного вмісту текстового файлу, можна, скажімо, додавати відступи перед параграфами, що починаються з двох-трьох пробілів поспіль, тощо…<br /><br /><a name="1_7"></a><br /><h3>1.7.&nbsp;вставити пусті рядки під вибраним текстом</h3>задача: вставити пусті рядки вибірково, після кожного текстового рядка, що відповідає певному шаблону.<br /><blockquote><code>sed '/regex/G'</code></blockquote>комбінація фільтру з регулярним виразом (<a href="http:/#1_6">див. п. 1.6</a>) і команди G (<a href="http:/#1_1">див. п. 1.1</a>) — редактор завантажує рядок тексту з вхідного потоку, і якщо той відповідає шаблону, подає у вихідний поток, додавши позаду символ нового рядка.<br /><br />приклад:<br /><blockquote><code>cat test.txt | sed '/^.*[Бб]андура.*/G'</code></blockquote>результат: вивід в терміналі, в якому після кожного рядка, що містить слово «бандура», буде додано один пустий інтервал (<a href="http:/#0_2">в прикладі</a> такий рядок лише один, перший).<br /><br />інший приклад:<br /><blockquote><code>cat test.txt | sed '/^\t.*/G'</code></blockquote>результат: після кожного рядка, що починається символом табуляції (<a href="http:/#0_2">в приклад</a>і таких чотири) буде додано один пустий інтервал.<br /><br /><a name="1_8"></a><br /><h3>1.8. вставити пусті рядки над і під вибраним текстом</h3>задача: вставити пусті рядки вибірково, над і під кожним текстовим рядком, що відповідає певному шаблону.<br /><blockquote>sed '/regexp/ {x;p;x;G;}</blockquote>комбінація двох попередніх рішень (<a href="http:/#1_6">див. п. 1.6</a> та <a href="http:/#1_7">1.7</a>), згрупованих в одну команду за допомогою <i>{}</i>.<br /><br /><a name="1_9"></a><br /><h3>1.9.&nbsp;вилучити непарні рядки</h3>задача: вилучити всі непарні (перший, третій і т.д.) рядки з тексту.<br /><blockquote><code>sed '1~2d'</code></blockquote>попередній спосіб видалення парних рядків (див. п. 1.5), попри певну «алгоритмічну» красу, насправді поганий — бо важкозрозумілий. є значно простіший спосіб вибрати кожен k-тий рядок, починаючи з n-го: достатньо всього-лиш вказати <i>n~k</i>! а команда <i>d</i> видалить вибране. тож якщо потрібен кожен парний рядок, починаючи з другого — це 2~2, а якщо кожен непарний, починаючи з першого — це 1~2. просто, зрозуміло, і легко запам’ятати.<br /><br />приклад:<br /><blockquote><code>cat test.txt | sed '1~2d'</code></blockquote>результат: вивід тексту без непарних рядків.<br /><br />іще приклад:<br /><blockquote><code>cat test.txt | sed '/^$/d' | sed '2~2d'</code></blockquote>результат: вивід тексту, в якому спершу видалено усі пусті рядки (перший sed), а потім усі парні текстові рядки (другий sed).<br /><br />наразі вистачить, <a href="http://www.tivasyk.info/2010/09/sed-2.html#more">далі ще обов’язково буде</a>.