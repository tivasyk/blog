---
layout: post
title:  "сервер v2"
date:   2021-01-09 21:01
categories: blog
tags: 
  - щоденник
  - комп'ютери
  - сервер
---
моєму домашньому серверу — півтора роки, якщо вважати [день запуску першого сервісу (owncloud)]({% post_url 2019/2019-07-10-blog-post_11 %}) за його «день народження». за весь час перезавантажувався двічі — раз через тривале відключення електрики (ups не витримав), другий раз вже не пригадаю навіщо. на сервері крутяться щоденник (jekyll, lighttpd), pi-hole та owncloud. мені, до речі, сподобався docker для запуску сервісів — трохи мороки на старті через брак документації, але далі зазвичай все просто працює без потреби «адмініструвати» сервер.

і все було би чудово, не треба було би нічого міняти, якби не owncloud — не лише я, але й родина звикли вивантажувати туди світлини й відео з телефонів, плюс звідти роздаються (привезені ще з україни) фільми, по dlna на телевізор… але файлове сховище досі залежить від одного-єдиного диска, без бекапів, і це рецепт маленької катастрофи. плюс хочеться більше місця на owncloud (хоча й ті 500 гб поки що зайняті лише на третину).

звідси два сценарії крутяться в голові: проапгрейдити цей старенький [hp compaq dc5800]({% post_url 2019/2019-07-05-blog-post %}), додавши другий диск для копіювання всього вмісту owncloud? або зібрати заміну на базі [hp compaq 8100 elite](https://support.hp.com/rs-en/document/c02030592), що впав мені до рук днями? теж старий мотлох, але [intel core i5-650 замість pentium e5200](http://cpuboss.com/cpus/Intel-Pentium-E5200-vs-Intel-Core-i5-650) і ddr3 1333 ггц замість ddr2 800 ггц, плюс можна гратися з налаштуванням, не ламаючи того, що є зараз, і мігрувати, коли готовий.


#### проєкт

* [x] викинути оптичний дисковод, звільнивши місце для бекплейна на 6 дисків sata 2,5" (вже придбав для цього дешевий китайський [olmaster c3804](https://www.aliexpress.com/i/32791168648.html)) для простого доступу до дисків;
* [ ] забити бекплейн дешевими дисками; 
* [ ] вирішити щось із дублюванням чи резервним копіюванням: zfs? btrfs? чи просто ext4+mergefs+snapraid? чи навіть просто два розділи lvm в програмному raid0?;
* [ ] спробувати [nextcloud](https://nextcloud.com/athome/) замість owncloud (бо розвинутіший набір аплетів, який майже може замінити google колись);
* [ ] налаштувати автогасіння сервера від ups під час відключення електрики;
* [ ] (опційно) налаштувати резервне копіювання до aws?
* [ ] (опційно) спробувати підняти всі сервіси на «голому» debian (або proxmox'і) за допомогою лише ansible?

![бекплейн olmaster c3804 на 6 дисків sata 2,5"](/assets/images/2021/2021-01-09-server-v2_01.jpg)


#### витрати

* hp compaq 8100 elite (без дисків і лише з 2 гб пам'яті) = 0,00$
* бекплейн olmaster c3804 (aliexpress) = 65,95$
* адаптер pcie до sata x4 iocrest si-pex40064 (kijiji) = 30,00$
* адаптер живлення sata до molex для бекплейна (amazon) = 10,34$
* пам'ять 4×4 гб (amazon) = 105,75$
* системний ssd 240 гб kingston a400 (amazon) = 45,95$
* диски «зі сміттярки» 
  * 2×500 гб seagate momentus thin 2,5" sata (kijiji) = 30,00$

вартість повна (з доставкою і податками) в канадійських доларах (cad).

![зібрана «заготовка»](/assets/images/2021/2021-01-09-server-v2_03.jpg)


#### встановлення базової системи

на перший погляд, hp compaq 8100 elite — не така вже й старезна система, але примхлива: з першої спроби відмовилася завантажувати debian (9.9.0 netinst) та proxmox (6.1) з перевірених флешок, — але завантажила clonezilla (2.6.4.10), xcp-ng (8.1) та, зненацька, manjaro (kde 18.1.5 minimal). 

![manjaro завантажвся з live usb](/assets/images/2021/2021-01-09-server-v2_02.jpg)

я вже збирався [трясти бубном](https://www.debian.org/releases/stretch/amd64/apds03.html.en), але наостанок спробував перезаписати debian 10 на флешку не так, як зазвичай (dd), а [як книжка пише](https://www.debian.org/releases/stable/amd64/ch04s03.en.html):

    # cp debian-*-amd64-netinst.iso /dev/sdX && sync
    
хз, чому `dd` виявився недостатньо хороший для цієї материнки, але тут все «завелося», тож далі встановлюю debian як зазвичай. після налаштування статичного ip, sudo для користувача, сервера ssh — можна йти «курити» ansible, мабуть? 

але тут я задумався: граючись із ansible, я гарантовано поламаю систему, і не раз. доведеться знову перевстановлювати руцями? було би значно простіше мати під сподом гіпервізор, і бекапити/відновлювати віртуальну машину з debian стільки разів, скільки треба, в тому числі й за допомогою того ж таки ansible. proxmox виглядає як найкращий варіант для домашнього використання, але оскільки з флешки він ніяк не хоче завантажуватися на цій машині, довелося [зробити руцями](https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_Buster).

![proxmox поверх debian](/assets/images/2021/2021-01-09-server-v2_04.jpg)

аж от тепер можна йти «курити» ansible!

далі буде…